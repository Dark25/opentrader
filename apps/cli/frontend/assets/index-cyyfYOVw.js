import{aX as O,aW as A}from"./index-DacOZnWA.js";import{b as x}from"./browser-BwFqrqKh.js";import{r as E}from"./assert-qSoQSbtu.js";import{A as T}from"./index-BXo9w5xs.js";import"./__vite-browser-external-v7f2oYTb.js";var I=E();const S=O(I);function N(t){return new Promise((n,e)=>{let r=0;const a=[];function o(){const i=t.read();i?h(i):t.once("readable",o)}function c(){t.removeListener("end",d),t.removeListener("error",l),t.removeListener("close",u),t.removeListener("readable",o)}function u(i){}function d(){}function l(i){c(),e(i)}function h(i){a.push(i),r+=i.length;const f=A.concat(a,r);if(f.indexOf(`\r
\r
`)===-1){o();return}const C=f.toString("ascii").split(`\r
`),$=C.shift();if(!$)throw new Error("No header received");const g=$.split(" "),H=+g[1],L=g.slice(2).join(" "),y={};for(const p of C){if(!p)continue;const P=p.indexOf(":");if(P===-1)throw new Error(`Invalid header: "${p}"`);const w=p.slice(0,P).toLowerCase(),v=p.slice(P+1).trimStart(),m=y[w];typeof m=="string"?y[w]=[m,v]:Array.isArray(m)?m.push(v):y[w]=v}c(),n({connect:{statusCode:H,statusText:L,headers:y},buffered:f})}t.on("error",l),t.on("close",u),t.on("end",d),o()})}class R extends T{constructor(n,e){super(e),this.options={path:void 0},this.proxy=typeof n=="string"?new URL(n):n,this.proxyHeaders=(e==null?void 0:e.headers)??{};const r=(this.proxy.hostname||this.proxy.host).replace(/^\[|\]$/g,""),a=this.proxy.port?parseInt(this.proxy.port,10):this.secureProxy?443:80;this.connectOpts={ALPNProtocols:["http/1.1"],...e?b(e,"headers"):null,host:r,port:a}}get secureProxy(){return j(this.proxy.protocol)}async connect(n,e){const{proxy:r,secureProxy:a}=this;if(!e.host)throw new TypeError('No "host" provided');let o;a?o=(void 0)(this.connectOpts):o=x.connect(this.connectOpts);const c=typeof this.proxyHeaders=="function"?this.proxyHeaders():{...this.proxyHeaders},u=x.isIPv6(e.host)?`[${e.host}]`:e.host;let d=`CONNECT ${u}:${e.port} HTTP/1.1\r
`;if(r.username||r.password){const s=`${decodeURIComponent(r.username)}:${decodeURIComponent(r.password)}`;c["Proxy-Authorization"]=`Basic ${A.from(s).toString("base64")}`}c.Host=`${u}:${e.port}`,c["Proxy-Connection"]||(c["Proxy-Connection"]=this.keepAlive?"Keep-Alive":"close");for(const s of Object.keys(c))d+=`${s}: ${c[s]}\r
`;const l=N(o);o.write(`${d}\r
`);const{connect:h,buffered:i}=await l;if(n.emit("proxyConnect",h),this.emit("proxyConnect",h,n),h.statusCode===200){if(n.once("socket",U),e.secureEndpoint){const s=e.servername||e.host;return(void 0)({...b(e,"host","path","port"),socket:o,servername:x.isIP(s)?void 0:s})}return o}o.destroy();const f=new x.Socket({writable:!1});return f.readable=!0,n.once("socket",s=>{S(s.listenerCount("data")>0),s.push(i),s.push(null)}),f}}R.protocols=["http","https"];function U(t){t.resume()}function j(t){return typeof t=="string"?/^https:?$/i.test(t):!1}function b(t,...n){const e={};let r;for(r in t)n.includes(r)||(e[r]=t[r]);return e}export{R as HttpsProxyAgent};
