import{aY as l,aW as S,aX as H}from"./index-DacOZnWA.js";import{b as C,r as D}from"./browser-BwFqrqKh.js";import{b as T,r as L,s as E}from"./index-BJj6QqBT.js";import{r as M}from"./assert-qSoQSbtu.js";function k(e,o){for(var r=0;r<o.length;r++){const t=o[r];if(typeof t!="string"&&!Array.isArray(t)){for(const a in t)if(a!=="default"&&!(a in e)){const n=Object.getOwnPropertyDescriptor(t,a);n&&Object.defineProperty(e,a,n.get?n:{enumerable:!0,get:()=>t[a]})}}}return Object.freeze(Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}))}var v={},$={},N=l&&l.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty($,"__esModule",{value:!0});const q=N(T),_=q.default("https-proxy-agent:parse-proxy-response");function B(e){return new Promise((o,r)=>{let t=0;const a=[];function n(){const s=e.read();s?u(s):e.once("readable",n)}function i(){e.removeListener("end",p),e.removeListener("error",c),e.removeListener("close",y),e.removeListener("readable",n)}function y(s){_("onclose had error %o",s)}function p(){_("onend")}function c(s){i(),_("onerror %o",s),r(s)}function u(s){a.push(s),t+=s.length;const d=S.concat(a,t);if(d.indexOf(`\r
\r
`)===-1){_("have not received end of HTTP headers yet..."),n();return}const b=d.toString("ascii",0,d.indexOf(`\r
`)),x=+b.split(" ")[1];_("got proxy server response: %o",b),o({statusCode:x,buffered:d})}e.on("error",c),e.on("close",y),e.on("end",p),n()})}$.default=B;var R=l&&l.__awaiter||function(e,o,r,t){function a(n){return n instanceof r?n:new r(function(i){i(n)})}return new(r||(r=Promise))(function(n,i){function y(u){try{c(t.next(u))}catch(s){i(s)}}function p(u){try{c(t.throw(u))}catch(s){i(s)}}function c(u){u.done?n(u.value):a(u.value).then(y,p)}c((t=t.apply(e,o||[])).next())})},h=l&&l.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(v,"__esModule",{value:!0});const w=h(C),j=h(D),z=h(L),F=h(M()),G=h(T),I=E,U=h($),g=G.default("https-proxy-agent:agent");class W extends I.Agent{constructor(o){let r;if(typeof o=="string"?r=z.default.parse(o):r=o,!r)throw new Error("an HTTP(S) proxy server `host` and `port` must be specified!");g("creating new HttpsProxyAgent instance: %o",r),super(r);const t=Object.assign({},r);this.secureProxy=r.secureProxy||J(t.protocol),t.host=t.hostname||t.host,typeof t.port=="string"&&(t.port=parseInt(t.port,10)),!t.port&&t.host&&(t.port=this.secureProxy?443:80),this.secureProxy&&!("ALPNProtocols"in t)&&(t.ALPNProtocols=["http 1.1"]),t.host&&t.path&&(delete t.path,delete t.pathname),this.proxy=t}callback(o,r){return R(this,void 0,void 0,function*(){const{proxy:t,secureProxy:a}=this;let n;a?(g("Creating `tls.Socket`: %o",t),n=j.default.connect(t)):(g("Creating `net.Socket`: %o",t),n=w.default.connect(t));const i=Object.assign({},t.headers);let p=`CONNECT ${`${r.host}:${r.port}`} HTTP/1.1\r
`;t.auth&&(i["Proxy-Authorization"]=`Basic ${S.from(t.auth).toString("base64")}`);let{host:c,port:u,secureEndpoint:s}=r;Y(u,s)||(c+=`:${u}`),i.Host=c,i.Connection="close";for(const f of Object.keys(i))p+=`${f}: ${i[f]}\r
`;const d=U.default(n);n.write(`${p}\r
`);const{statusCode:O,buffered:b}=yield d;if(O===200){if(o.once("socket",X),r.secureEndpoint){g("Upgrading socket connection to TLS");const f=r.servername||r.host;return j.default.connect(Object.assign(Object.assign({},K(r,"host","hostname","path","port")),{socket:n,servername:f}))}return n}n.destroy();const x=new w.default.Socket({writable:!1});return x.readable=!0,o.once("socket",f=>{g("replaying proxy buffer for failed request"),F.default(f.listenerCount("data")>0),f.push(b),f.push(null)}),x})}}v.default=W;function X(e){e.resume()}function Y(e,o){return!!(!o&&e===80||o&&e===443)}function J(e){return typeof e=="string"?/^https:?$/i.test(e):!1}function K(e,...o){const r={};let t;for(t in e)o.includes(t)||(r[t]=e[t]);return r}var Q=l&&l.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const m=Q(v);function P(e){return new m.default(e)}(function(e){e.HttpsProxyAgent=m.default,e.prototype=m.default.prototype})(P||(P={}));var A=P;const V=H(A),ne=k({__proto__:null,default:V},[A]);export{ne as i};
